<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Tạo phiếu xuất kho - 2FATE Motor</title>

    <!-- Đồng bộ với admin dashboard -->
    <link rel="stylesheet" href="/css/admin.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/css_admin/export_receipt_new.css">
</head>

<body>
    <%- include('../partials/header_admin') %>

        <div class="container-fluid">
            <div class="row">

                <%- include('../partials/sidebar_admin') %>

                    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 mt-4">

                        <!-- TITLE + BACK BUTTON -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="text-primary">
                                <i class="bi bi-plus-circle"></i> Tạo phiếu xuất kho
                            </h1>

                            <a href="/admin/export-receipts" class="btn btn-secondary shadow-sm">
                                <i class="bi bi-arrow-left"></i> Quay lại
                            </a>
                        </div>

                        <!-- FORM -->
                        <form id="exportReceiptForm">

                            <!-- BASIC INFO CARD -->
                            <div class="info-card">
                                <h5 class="mb-3"><i class="bi bi-info-circle text-danger"></i> Thông tin cơ bản</h5>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Kho xuất <span class="text-danger">*</span></label>
                                        <select class="form-select" name="warehouse_id" id="warehouseSelect" required
                                            onchange="loadInventory()">
                                            <option value="">-- Chọn kho --</option>
                                            <% warehouses.forEach(w=> { %>
                                                <option value="<%= w.id %>">
                                                    <%= w.name %>
                                                </option>
                                                <% }) %>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Tên khách hàng</label>
                                        <input type="text" class="form-control" name="customer_name">
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Số điện thoại</label>
                                        <input type="tel" class="form-control" name="customer_phone">
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Ghi chú</label>
                                        <textarea class="form-control" name="notes" rows="1"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- PRODUCT LIST -->
                            <div class="items-card">

                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0"><i class="bi bi-box-seam text-danger"></i> Danh sách sản phẩm</h5>

                                    <button type="button" id="addProductBtn" class="btn btn-success shadow-sm"
                                        onclick="addProductRow()" disabled>
                                        <i class="bi bi-plus-circle"></i> Thêm sản phẩm
                                    </button>
                                </div>

                                <div id="productsContainer"></div>

                            </div>

                            <!-- TOTAL -->
                            <div class="total-alert">
                                <h5>Tổng giá trị: <strong id="totalAmount">0 ₫</strong></h5>
                            </div>

                            <!-- SUBMIT BUTTON -->
                            <div class="text-center">
                                <button type="submit" class="btn btn-danger btn-lg px-5 shadow-sm">
                                    <i class="bi bi-check-circle"></i> Tạo phiếu xuất
                                </button>
                            </div>

                        </form>
                    </main>
            </div>
        </div>

        <!-- SCRIPT -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            let inventory = [];
            let productCounter = 0;

            async function loadInventory() {
                const warehouseId = document.getElementById('warehouseSelect').value;
                if (!warehouseId) return;

                const response = await fetch(`/api/warehouses/${warehouseId}/inventory`);
                const result = await response.json();

                if (result.success) {
                    inventory = result.inventory;
                    document.getElementById('addProductBtn').disabled = false;
                    document.getElementById('productsContainer').innerHTML = '';
                }
            }

            function addProductRow() {
                if (inventory.length === 0) {
                    alert('Kho chưa có sản phẩm!');
                    return;
                }

                productCounter++;

                const options = inventory.map(item =>
                    `<option value="${item.product_id}" data-price="${item.price}" data-stock="${item.quantity}">
                    ${item.name} - Tồn: ${item.quantity}
                </option>`
                ).join('');

                const html = `
                <div class="product-card" id="product-${productCounter}">
                    <button type="button" class="remove-btn" onclick="removeProduct(${productCounter})">
                        <i class="bi bi-x"></i>
                    </button>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Sản phẩm</label>
                            <select class="form-select product-select" onchange="updatePrice(this)" required>
                                <option value="">-- Chọn sản phẩm --</option>
                                ${options}
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">Số lượng</label>
                            <input type="number" class="form-control quantity-input" min="1" value="1"
                                onchange="calculateTotal()" required>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">Tồn kho</label>
                            <input type="text" class="form-control stock-display" readonly style="background: #f8f9fa;">
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">Đơn giá</label>
                            <input type="text" class="form-control price-input" readonly style="background: #f8f9fa;">
                        </div>
                    </div>

                </div>
            `;

                document.getElementById('productsContainer').insertAdjacentHTML('beforeend', html);
            }

            function removeProduct(id) {
                document.getElementById(`product-${id}`)?.remove();
                calculateTotal();
            }

            function updatePrice(select) {
                const option = select.options[select.selectedIndex];
                const card = select.closest(".product-card");

                card.querySelector(".price-input").value = option.dataset.price || "";
                card.querySelector(".stock-display").value = option.dataset.stock || "";

                calculateTotal();
            }

            function calculateTotal() {
                let total = 0;
                document.querySelectorAll('.product-card').forEach(card => {
                    const qty = Number(card.querySelector('.quantity-input')?.value) || 0;
                    const price = Number(card.querySelector('.price-input')?.value) || 0;
                    total += qty * price;
                });

                document.getElementById("totalAmount").textContent =
                    new Intl.NumberFormat('vi-VN').format(total) + ' ₫';
            }

            document.getElementById("exportReceiptForm").addEventListener("submit", async function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const items = [];

                document.querySelectorAll('.product-card').forEach(card => {
                    const select = card.querySelector(".product-select");
                    if (!select || !select.value) return;

                    const quantity = Number(card.querySelector(".quantity-input").value);
                    const stock = Number(card.querySelector(".stock-display").value);
                    const price = Number(card.querySelector(".price-input").value);

                    if (quantity > stock) {
                        alert(`❌ Không đủ tồn kho! Có: ${stock}, yêu cầu: ${quantity}`);
                        throw new Error("Insufficient stock");
                    }

                    items.push({
                        product_id: Number(select.value),
                        quantity,
                        unit_price: price
                    });
                });

                if (items.length === 0) {
                    alert("⚠️ Vui lòng thêm sản phẩm!");
                    return;
                }

                const response = await fetch("/admin/export-receipts/create", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        warehouse_id: Number(formData.get("warehouse_id")),
                        customer_name: formData.get("customer_name"),
                        customer_phone: formData.get("customer_phone"),
                        notes: formData.get("notes"),
                        items
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert("✅ Tạo phiếu xuất thành công!");
                    window.location.href = `/admin/export-receipts/${result.receiptId}`;
                } else {
                    alert("❌ " + result.message);
                }
            });
        </script>
</body>

</html>