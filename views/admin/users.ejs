<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Quản lý Người dùng - Bike Store</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .status-online {
            color: #28a745;
        }

        .status-offline {
            color: #6c757d;
        }

        .status-active {
            color: #28a745;
        }

        .status-banned {
            color: #dc3545;
        }

        .status-suspended {
            color: #ffc107;
        }

        .activity-info {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .privacy-notice {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .action-btn {
            padding: 4px 8px;
            font-size: 0.85rem;
            margin: 2px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .table-actions {
            min-width: 180px;
        }

        .badge-role {
            font-size: 0.85rem;
            padding: 6px 12px;
        }

        .user-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            padding: 20px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin: 0;
            color: #667eea;
        }

        .stat-card p {
            margin: 5px 0 0 0;
            color: #6c757d;
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .modal-backdrop.show {
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <%- include('../partials/header_admin') %>
        <div class="container-fluid">
            <div class="row">
                <%- include('../partials/sidebar_admin') %>
                    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 mt-4">
                        <h1 class="mb-4 text-primary">
                            <i class="bi bi-people-fill"></i> Quản lý Người dùng
                        </h1>

                        <!-- Statistics -->
                        <div class="user-stats">
                            <div class="stat-card">
                                <h3>
                                    <%= users.length %>
                                </h3>
                                <p><i class="bi bi-people"></i> Tổng người dùng</p>
                            </div>
                            <div class="stat-card">
                                <h3>
                                    <%= users.filter(u=> u.is_online).length %>
                                </h3>
                                <p><i class="bi bi-circle-fill status-online"></i> Đang online</p>
                            </div>
                            <div class="stat-card">
                                <h3>
                                    <%= users.filter(u=> u.role === 'admin').length %>
                                </h3>
                                <p><i class="bi bi-shield-fill-check"></i> Admin</p>
                            </div>
                            <div class="stat-card">
                                <h3>
                                    <%= users.filter(u=> u.account_status === 'banned').length %>
                                </h3>
                                <p><i class="bi bi-ban"></i> Bị cấm</p>
                            </div>
                        </div>

                        <!-- Privacy Notice -->
                        <div class="privacy-notice">
                            <i class="bi bi-info-circle"></i>
                            <strong>Lưu ý:</strong> Thông tin hoạt động được ghi nhận để đảm bảo an ninh hệ thống.
                            Dữ liệu được bảo mật và chỉ Admin mới có quyền truy cập.
                        </div>

                        <!-- Filter Section -->
                        <div class="filter-section">
                            <div class="row align-items-end">
                                <div class="col-md-3">
                                    <label class="form-label">Vai trò</label>
                                    <select class="form-select" id="filterRole">
                                        <option value="">Tất cả</option>
                                        <option value="admin">Admin</option>
                                        <option value="user">User</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Trạng thái tài khoản</label>
                                    <select class="form-select" id="filterStatus">
                                        <option value="">Tất cả</option>
                                        <option value="active">Hoạt động</option>
                                        <option value="banned">Bị cấm</option>
                                        <option value="suspended">Tạm khóa</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Trạng thái online</label>
                                    <select class="form-select" id="filterOnline">
                                        <option value="">Tất cả</option>
                                        <option value="online">Online</option>
                                        <option value="offline">Offline</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary w-100" onclick="applyFilters()">
                                        <i class="bi bi-funnel"></i> Lọc
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle" id="usersTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Người dùng</th>
                                                <th>Email</th>
                                                <th>Vai trò</th>
                                                <th>Trạng thái TK</th>
                                                <th>Online</th>
                                                <th>Đăng nhập cuối</th>
                                                <th>Đăng xuất cuối</th>
                                                <th class="table-actions">Hành động</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% users.forEach(user=> { %>
                                                <tr data-user-id="<%= user.id %>" data-role="<%= user.role %>"
                                                    data-status="<%= user.account_status || 'active' %>"
                                                    data-online="<%= user.is_online ? 'online' : 'offline' %>">
                                                    <td>
                                                        <%= user.id %>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar me-2">
                                                                <%= user.username.charAt(0).toUpperCase() %>
                                                            </div>
                                                            <strong>
                                                                <%= user.username %>
                                                            </strong>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <%= user.email %>
                                                    </td>
                                                    <td>
                                                        <span
                                                            class="badge badge-role <%= user.role === 'admin' ? 'bg-danger' : 'bg-primary' %>">
                                                            <i
                                                                class="bi <%= user.role === 'admin' ? 'bi-shield-fill-check' : 'bi-person' %>"></i>
                                                            <%= user.role %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <% const accountStatus=user.account_status || 'active' ; %>
                                                            <% if (accountStatus==='active' ) { %>
                                                                <span class="badge bg-success">
                                                                    <i class="bi bi-check-circle"></i> Hoạt động
                                                                </span>
                                                                <% } else if (accountStatus==='banned' ) { %>
                                                                    <span class="badge bg-danger">
                                                                        <i class="bi bi-ban"></i> Bị cấm
                                                                    </span>
                                                                    <% } else if (accountStatus==='suspended' ) { %>
                                                                        <span class="badge bg-warning text-dark">
                                                                            <i class="bi bi-pause-circle"></i> Tạm khóa
                                                                        </span>
                                                                        <% } %>
                                                    </td>
                                                    <td>
                                                        <% if (user.is_online) { %>
                                                            <i class="bi bi-circle-fill status-online"></i> Online
                                                            <% } else { %>
                                                                <i class="bi bi-circle-fill status-offline"></i> Offline
                                                                <% } %>
                                                    </td>
                                                    <td>
                                                        <% if (user.last_login) { %>
                                                            <%= new Date(user.last_login).toLocaleString('vi-VN', {
                                                                day: '2-digit' , month: '2-digit' , year: 'numeric' ,
                                                                hour: '2-digit' , minute: '2-digit' }) %>
                                                                <% } else { %>
                                                                    <span class="text-muted">Chưa đăng nhập</span>
                                                                    <% } %>
                                                    </td>
                                                    <td>
                                                        <% if (user.last_logout) { %>
                                                            <%= new Date(user.last_logout).toLocaleString('vi-VN', {
                                                                day: '2-digit' , month: '2-digit' , year: 'numeric' ,
                                                                hour: '2-digit' , minute: '2-digit' }) %>
                                                                <% } else { %>
                                                                    <span class="text-muted">-</span>
                                                                    <% } %>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group" role="group">
                                                            <!-- Change Role -->
                                                            <% if (user.role==='user' ) { %>
                                                                <button class="btn btn-sm btn-success action-btn"
                                                                    onclick="changeRole('<%= user.id %>', 'admin')"
                                                                    title="Lên Admin">
                                                                    <i class="bi bi-arrow-up-circle"></i>
                                                                </button>
                                                                <% } else if (user.role==='admin' && user.id
                                                                    !==locals.user.id) { %>
                                                                    <button class="btn btn-sm btn-warning action-btn"
                                                                        onclick="changeRole('<%= user.id %>', 'user')"
                                                                        title="Xuống User">
                                                                        <i class="bi bi-arrow-down-circle"></i>
                                                                    </button>
                                                                    <% } %>

                                                                        <!-- Ban/Unban -->
                                                                        <% const status=user.account_status || 'active'
                                                                            ; %>
                                                                            <% if (status==='active' && user.id
                                                                                !==locals.user.id) { %>
                                                                                <button
                                                                                    class="btn btn-sm btn-danger action-btn"
                                                                                    onclick="banUser('<%= user.id %>')"
                                                                                    title="Cấm tài khoản">
                                                                                    <i class="bi bi-ban"></i>
                                                                                </button>
                                                                                <% } else if (status==='banned' ) { %>
                                                                                    <button
                                                                                        class="btn btn-sm btn-success action-btn"
                                                                                        onclick="unbanUser('<%= user.id %>')"
                                                                                        title="Mở khóa">
                                                                                        <i class="bi bi-unlock"></i>
                                                                                    </button>
                                                                                    <% } %>

                                                                                        <!-- Delete -->
                                                                                        <% if (user.id
                                                                                            !==locals.user.id) { %>
                                                                                            <button
                                                                                                class="btn btn-sm btn-dark action-btn"
                                                                                                onclick="deleteUser('<%= user.id %>', '<%= user.username %>')"
                                                                                                title="Xóa vĩnh viễn">
                                                                                                <i
                                                                                                    class="bi bi-trash"></i>
                                                                                            </button>
                                                                                            <% } %>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Legend -->
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-circle-fill status-online"></i> Online
                                <span class="ms-3"><i class="bi bi-circle-fill status-offline"></i> Offline</span>
                                <span class="ms-3"><i class="bi bi-shield-fill-check text-danger"></i> Admin</span>
                                <span class="ms-3"><i class="bi bi-person text-primary"></i> User</span>
                            </small>
                        </div>
                    </main>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Change user role
            async function changeRole(userId, newRole) {
                const roleName = newRole === 'admin' ? 'Admin' : 'User';
                if (!confirm(`Bạn có chắc muốn thay đổi quyền thành ${roleName}?`)) return;

                try {
                    const response = await fetch('/admin/users/change-role', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId, role: newRole })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('✅ Đã thay đổi quyền thành công!');
                        location.reload();
                    } else {
                        alert('❌ ' + (data.message || 'Không thể thay đổi quyền!'));
                    }
                } catch (error) {
                    alert('❌ Lỗi: ' + error.message);
                }
            }

            // Ban user
            async function banUser(userId) {
                const reason = prompt('Lý do cấm tài khoản:');
                if (!reason || reason.trim().length < 5) {
                    alert('⚠️ Vui lòng nhập lý do cấm (tối thiểu 5 ký tự)!');
                    return;
                }

                if (!confirm('⚠️ Xác nhận cấm tài khoản này?\n\nLý do: ' + reason)) return;

                try {
                    const response = await fetch('/admin/users/ban', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId, reason })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('✅ Đã cấm tài khoản!\n\nTài khoản sẽ không thể đăng nhập và bị chặn gửi yêu cầu mở khóa trong 24h.');

                        // Cập nhật UI ngay lập tức
                        const row = document.querySelector(`tr[data-user-id="${userId}"]`);
                        if (row) {
                            // Cập nhật trạng thái data attribute
                            row.dataset.status = 'banned';

                            // Cập nhật badge trạng thái
                            const statusCell = row.cells[4];
                            statusCell.innerHTML = `
                            <span class="badge bg-danger">
                                <i class="bi bi-ban"></i> Bị cấm
                            </span>
                        `;

                            // Cập nhật nút hành động
                            const actionsCell = row.cells[8];
                            const btnGroup = actionsCell.querySelector('.btn-group');

                            // Tìm và thay thế nút Ban bằng nút Unban
                            const banBtn = btnGroup.querySelector('.btn-danger');
                            if (banBtn) {
                                banBtn.outerHTML = `
                                <button class="btn btn-sm btn-success action-btn" 
                                        onclick="unbanUser('${userId}')"
                                        title="Mở khóa">
                                    <i class="bi bi-unlock"></i>
                                </button>
                            `;
                            }
                        }

                        // Cập nhật số liệu thống kê
                        updateStats();
                    } else {
                        alert('❌ ' + (data.message || 'Không thể cấm tài khoản!'));
                    }
                } catch (error) {
                    alert('❌ Lỗi: ' + error.message);
                }
            }

            // Unban user
            async function unbanUser(userId) {
                if (!confirm('Bạn có chắc muốn mở khóa tài khoản này?')) return;

                try {
                    const response = await fetch('/admin/users/unban', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('✅ Đã mở khóa tài khoản!\n\nTài khoản có thể đăng nhập trở lại.');

                        // Cập nhật UI ngay lập tức
                        const row = document.querySelector(`tr[data-user-id="${userId}"]`);
                        if (row) {
                            // Cập nhật trạng thái data attribute
                            row.dataset.status = 'active';

                            // Cập nhật badge trạng thái
                            const statusCell = row.cells[4];
                            statusCell.innerHTML = `
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle"></i> Hoạt động
                            </span>
                        `;

                            // Cập nhật nút hành động
                            const actionsCell = row.cells[8];
                            const btnGroup = actionsCell.querySelector('.btn-group');

                            // Tìm và thay thế nút Unban bằng nút Ban
                            const unbanBtn = btnGroup.querySelector('.btn-success[title="Mở khóa"]');
                            if (unbanBtn && row.dataset.userId !== '<%= locals.user.id %>') {
                                unbanBtn.outerHTML = `
                                <button class="btn btn-sm btn-danger action-btn" 
                                        onclick="banUser('${userId}')"
                                        title="Cấm tài khoản">
                                    <i class="bi bi-ban"></i>
                                </button>
                            `;
                            }
                        }

                        // Cập nhật số liệu thống kê
                        updateStats();
                    } else {
                        alert('❌ ' + (data.message || 'Không thể mở khóa!'));
                    }
                } catch (error) {
                    alert('❌ Lỗi: ' + error.message);
                }
            }

            // Hàm cập nhật thống kê
            function updateStats() {
                const rows = document.querySelectorAll('#usersTable tbody tr');
                const bannedCount = Array.from(rows).filter(row => row.dataset.status === 'banned').length;

                // Cập nhật số "Bị cấm" trong thống kê
                const statCards = document.querySelectorAll('.stat-card h3');
                if (statCards[3]) {
                    statCards[3].textContent = bannedCount;
                }
            }

            // Delete user
            async function deleteUser(userId, username) {
                if (!confirm(`⚠️ BẠN CHẮC CHẮN MUỐN XÓA VĨNH VIỄN TÀI KHOẢN "${username}"?\n\nHành động này KHÔNG THỂ HOÀN TÁC!`)) return;

                const confirm2 = prompt('Nhập "XOA" (viết hoa) để xác nhận:');
                if (confirm2 !== 'XOA') {
                    alert('Đã hủy xóa tài khoản');
                    return;
                }

                try {
                    const response = await fetch('/admin/users/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('✅ Đã xóa tài khoản!');
                        location.reload();
                    } else {
                        alert('❌ ' + (data.message || 'Không thể xóa tài khoản!'));
                    }
                } catch (error) {
                    alert('❌ Lỗi: ' + error.message);
                }
            }

            // Filter function
            function applyFilters() {
                const roleFilter = document.getElementById('filterRole').value;
                const statusFilter = document.getElementById('filterStatus').value;
                const onlineFilter = document.getElementById('filterOnline').value;

                const rows = document.querySelectorAll('#usersTable tbody tr');

                rows.forEach(row => {
                    const role = row.dataset.role;
                    const status = row.dataset.status;
                    const online = row.dataset.online;

                    let show = true;

                    if (roleFilter && role !== roleFilter) show = false;
                    if (statusFilter && status !== statusFilter) show = false;
                    if (onlineFilter && online !== onlineFilter) show = false;

                    row.style.display = show ? '' : 'none';
                });
            }

            // Reset filters on page load
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('filterRole').value = '';
                document.getElementById('filterStatus').value = '';
                document.getElementById('filterOnline').value = '';
            });
        </script>
        <%- include('../partials/footer_admin') %>
</body>

</html>