<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>B√°o c√°o t·ªìn kho - 2FATE Motor</title>

    <!-- ƒê·ªìng b·ªô v·ªõi admin dashboard -->
    <link rel="stylesheet" href="/css/admin.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/css_admin/warehouse_reports.css">
</head>

<body>
    <%- include('../partials/header_admin') %>

        <div class="container-fluid">
            <div class="row">
                <%- include('../partials/sidebar_admin') %>

                    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 mt-4">

                        <h1 class="mb-4 text-primary">
                            <i class="bi bi-bar-chart"></i> B√°o c√°o t·ªìn kho
                        </h1>

                        <!-- STATISTICS -->
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-box blue">
                                    <div class="stat-value">
                                        <%= overview.length %>
                                    </div>
                                    <div class="stat-label">T·ªïng SKU</div>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="stat-box green">
                                    <div class="stat-value">
                                        <%= overview.reduce((sum, item)=> sum + item.quantity, 0) %>
                                    </div>
                                    <div class="stat-label">T·ªïng s·ªë l∆∞·ª£ng</div>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="stat-box orange">
                                    <div class="stat-value">
                                        <%= overview.filter(item=> item.stock_status === 'C·∫ßn nh·∫≠p th√™m').length %>
                                    </div>
                                    <div class="stat-label">S·∫Øp h·∫øt h√†ng</div>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="stat-box red">
                                    <div class="stat-value">
                                        <%= (overview.reduce((sum, item)=> sum + item.total_value, 0) /
                                            1000000).toFixed(1) %>M
                                    </div>
                                    <div class="stat-label">T·ªïng gi√° tr·ªã (‚Ç´)</div>
                                </div>
                            </div>
                        </div>

                        <!-- FILTERS -->
                        <div class="report-card no-print">
                            <div class="row g-3">

                                <div class="col-md-4">
                                    <input type="text" id="searchInput" class="form-control"
                                        placeholder="üîç T√¨m s·∫£n ph·∫©m...">
                                </div>

                                <div class="col-md-3">
                                    <select id="warehouseFilter" class="form-select">
                                        <option value="">T·∫•t c·∫£ kho</option>
                                        <% const warehouses=[...new Set(overview.map(o=> o.warehouse_name))]; %>
                                            <% warehouses.forEach(w=> { %>
                                                <option value="<%= w %>">
                                                    <%= w %>
                                                </option>
                                                <% }) %>
                                    </select>
                                </div>

                                <div class="col-md-3">
                                    <select id="statusFilter" class="form-select">
                                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                        <option value="C·∫ßn nh·∫≠p th√™m">C·∫ßn nh·∫≠p th√™m</option>
                                        <option value="B√¨nh th∆∞·ªùng">B√¨nh th∆∞·ªùng</option>
                                        <option value="T·ªìn kho nhi·ªÅu">T·ªìn kho nhi·ªÅu</option>
                                    </select>
                                </div>

                                <div class="col-md-2">
                                    <button class="btn btn-secondary w-100 shadow-sm" onclick="clearFilters()">
                                        <i class="bi bi-x-circle"></i> X√≥a l·ªçc
                                    </button>
                                </div>

                            </div>
                        </div>

                        <!-- TABLE -->
                        <div class="report-card">
                            <h5 class="mb-3">
                                <i class="bi bi-table text-primary"></i> Chi ti·∫øt t·ªìn kho
                            </h5>

                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="60">·∫¢nh</th>
                                            <th>S·∫£n ph·∫©m</th>
                                            <th>Kho</th>
                                            <th width="100">T·ªìn kho</th>
                                            <th width="100">Min</th>
                                            <th width="100">Max</th>
                                            <th width="150">Gi√° tr·ªã</th>
                                            <th width="150">Tr·∫°ng th√°i</th>
                                        </tr>
                                    </thead>

                                    <tbody id="reportTableBody">

                                        <% overview.forEach(item=> { %>
                                            <tr class="product-row" data-name="<%= item.product_name.toLowerCase() %>"
                                                data-warehouse="<%= item.warehouse_name %>"
                                                data-status="<%= item.stock_status %>">

                                                <td>
                                                    <img src="<%= item.image %>" class="product-img"
                                                        alt="<%= item.product_name %>">
                                                </td>

                                                <td><strong>
                                                        <%= item.product_name %>
                                                    </strong></td>

                                                <td>
                                                    <%= item.warehouse_name %>
                                                </td>

                                                <td>
                                                    <strong style="font-size: 1.2rem; color:#0d6efd;">
                                                        <%= item.quantity %>
                                                    </strong>
                                                </td>

                                                <td>
                                                    <%= item.min_quantity %>
                                                </td>
                                                <td>
                                                    <%= item.max_quantity %>
                                                </td>

                                                <td>
                                                    <strong style="color:#198754;">
                                                        <%= new Intl.NumberFormat('vi-VN').format(item.total_value) %> ‚Ç´
                                                    </strong>
                                                </td>

                                                <td>
                                                    <span class="stock-badge badge-<%= 
                                                item.stock_status === 'C·∫ßn nh·∫≠p th√™m' ? 'low' :
                                                item.stock_status === 'T·ªìn kho nhi·ªÅu' ? 'high' : 'normal'
                                            %>">
                                                        <%= item.stock_status %>
                                                    </span>
                                                </td>

                                            </tr>
                                            <% }) %>

                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ACTION BUTTONS -->
                        <div class="text-center mb-4 no-print">
                            <button class="btn btn-success btn-lg shadow-sm" onclick="exportToExcel()">
                                <i class="bi bi-file-earmark-excel"></i> Xu·∫•t Excel
                            </button>

                            <button class="btn btn-primary btn-lg shadow-sm" onclick="window.print()">
                                <i class="bi bi-printer"></i> In b√°o c√°o
                            </button>
                        </div>

                    </main>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            function filterTable() {
                const search = document.getElementById('searchInput').value.toLowerCase();
                const warehouse = document.getElementById('warehouseFilter').value;
                const status = document.getElementById('statusFilter').value;
                const rows = document.querySelectorAll('.product-row');

                rows.forEach(row => {
                    let show = true;
                    const name = row.dataset.name;
                    const wh = row.dataset.warehouse;
                    const st = row.dataset.status;

                    if (search && !name.includes(search)) show = false;
                    if (warehouse && wh !== warehouse) show = false;
                    if (status && st !== status) show = false;

                    row.style.display = show ? '' : 'none';
                });
            }

            document.getElementById('searchInput').addEventListener('input', filterTable);
            document.getElementById('warehouseFilter').addEventListener('change', filterTable);
            document.getElementById('statusFilter').addEventListener('change', filterTable);

            function clearFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('warehouseFilter').value = '';
                document.getElementById('statusFilter').value = '';
                filterTable();
            }

            function exportToExcel() {
                alert('Ch·ª©c nƒÉng xu·∫•t Excel s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t!');
            }
        </script>

</body>

</html>