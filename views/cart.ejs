<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Gi·ªè h√†ng - 2FATE Motor</title>
    <link rel="stylesheet" href="/css/cart.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .warning-box h3 {
            color: #856404;
            margin-top: 0;
        }

        .warning-item {
            padding: 10px;
            background: white;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }

        .stock-info {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .out-of-stock-row {
            background: #ffebee;
        }
    </style>
</head>

<body>
    <%- include("partials/header") %>

        <div class="cart-container">
            <h1>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h1>

            <% if (warnings && warnings.length> 0) { %>
                <div class="warning-box">
                    <h3>‚ö†Ô∏è C·∫£nh b√°o t·ªìn kho</h3>
                    <p>M·ªôt s·ªë s·∫£n ph·∫©m trong gi·ªè h√†ng c·ªßa b·∫°n kh√¥ng c√≤n ƒë·ªß s·ªë l∆∞·ª£ng:</p>
                    <% warnings.forEach(w=> { %>
                        <div class="warning-item">
                            <strong>
                                <%= w.productName %>
                            </strong> t·∫°i <strong>
                                <%= w.warehouse %>
                            </strong><br>
                            B·∫°n ƒë·∫∑t: <span style="color:#e74c3c">
                                <%= w.requested %>
                            </span> |
                            C√≤n l·∫°i: <span style="color:#27ae60">
                                <%= w.available %>
                            </span>
                        </div>
                        <% }) %>
                            <p style="margin-top:15px;color:#856404">
                                <strong>Vui l√≤ng c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ho·∫∑c x√≥a s·∫£n ph·∫©m kh√¥ng ƒë·ªß h√†ng!</strong>
                            </p>
                </div>
                <% } %>

                    <% if (cartItems.length===0) { %>
                        <div class="empty-cart">
                            <p>Gi·ªè h√†ng tr·ªëng.</p>
                            <a href="/search" class="btn">Ti·∫øp t·ª•c mua s·∫Øm</a>
                        </div>
                        <% } else { %>
                            <table class="cart-table">
                                <thead>
                                    <tr>
                                        <th>H√¨nh ·∫£nh</th>
                                        <th>S·∫£n ph·∫©m</th>
                                        <th>Chi nh√°nh</th>
                                        <th>M√†u</th>
                                        <th>S·ªë l∆∞·ª£ng</th>
                                        <th>Gi√°</th>
                                        <th>T·ªïng</th>
                                        <th>Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% cartItems.forEach(item=> {
                                        const stockQty = item.stock_quantity || 0;
                                        const isOutOfStock = stockQty < item.cart_quantity; %>
                                            <tr class="<%= isOutOfStock ? 'out-of-stock-row' : '' %>">
                                                <td><img src="<%= item.image %>" alt="" class="product-img"></td>
                                                <td>
                                                    <strong>
                                                        <%= item.name %>
                                                    </strong>
                                                    <% if (isOutOfStock) { %>
                                                        <div style="color:#e74c3c;font-size:0.9rem;margin-top:5px">
                                                            ‚ö†Ô∏è Kh√¥ng ƒë·ªß h√†ng!
                                                        </div>
                                                        <% } %>
                                                </td>
                                                <td>
                                                    <%= item.warehouse_name %>
                                                        <div class="stock-info">
                                                            T·ªìn kho: <strong>
                                                                <%= stockQty %>
                                                            </strong>
                                                        </div>
                                                </td>
                                                <td>
                                                    <%= item.color %>
                                                </td>
                                                <td>
                                                    <form action="/cart/update/<%= item.id %>" method="POST"
                                                        class="form-inline">
                                                        <input type="number" name="quantity"
                                                            value="<%= item.cart_quantity %>" min="0"
                                                            max="<%= stockQty %>" class="qty-input">
                                                        <button type="submit" class="btn-update">C·∫≠p nh·∫≠t</button>
                                                    </form>
                                                    <% if (isOutOfStock) { %>
                                                        <div style="color:#e74c3c;font-size:0.85rem;margin-top:5px">
                                                            Max: <%= stockQty %>
                                                        </div>
                                                        <% } %>
                                                </td>
                                                <td>
                                                    <%= item.price.toLocaleString() %> VND
                                                </td>
                                                <td>
                                                    <%= (item.price * item.cart_quantity).toLocaleString() %> VND
                                                </td>
                                                <td>
                                                    <form action="/cart/delete/<%= item.id %>" method="POST"
                                                        onsubmit="return confirm('X√≥a s·∫£n ph·∫©m n√†y?');">
                                                        <button type="submit" class="btn-delete">üóëÔ∏è X√≥a</button>
                                                    </form>
                                                </td>
                                            </tr>
                                            <% }) %>
                                </tbody>
                            </table>

                            <div class="cart-footer">
                                <h3>
                                    T·ªïng c·ªông:
                                    <%= cartItems.reduce((sum, i)=> sum + i.price * i.cart_quantity,
                                        0).toLocaleString() %> VND
                                </h3>

                                <% if (warnings && warnings.length> 0) { %>
                                    <p style="color:#e74c3c;margin:10px 0">
                                        ‚ö†Ô∏è Vui l√≤ng x·ª≠ l√Ω c√°c c·∫£nh b√°o tr∆∞·ªõc khi thanh to√°n!
                                    </p>
                                    <button class="btn-checkout" disabled style="background:#ccc;cursor:not-allowed">
                                        Kh√¥ng th·ªÉ thanh to√°n
                                    </button>
                                    <% } else { %>
                                        <form action="/checkout/address" method="GET" style="display:inline">
                                            <button type="submit" class="btn-checkout">Thanh to√°n ‚ûú</button>
                                        </form>
                                        <% } %>
                            </div>
                            <% } %>
        </div>

        <%- include("partials/footer") %>
</body>

</html>